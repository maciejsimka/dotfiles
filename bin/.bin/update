#!/bin/sh

# adapted from https://www.reddit.com/r/archlinux/comments/a6tl32/bash_script_that_wraps_the_output_of_checkupdates/

# arch news
printf "==============================\n"
printf "https://www.archlinux.org/news\n"
printf "==============================\n"

# nicked from some forum, not an ideal solution, but seems to work,
# formatting has been a little bit improved here
curl -s https://www.archlinux.org/feeds/news/ | \
xmllint --xpath //item/title\ \|\ //item/pubDate /dev/stdin | \
sed -r -e "s:<title>([^<]*?)</title><pubDate>([^<]*?)</pubDate>:\2 -- \1\n:g" | \
sed -r "s:&gt;:>:" | \
sed -r "s:&lt;:<:" | \
tr -s " " | \
cut -d " " --complement -f 1,5,6 | \
head -n5 # 5 of the most recent news items seems reasonable?

printf "\n===================\n"
printf "Checking updates...\n"
printf "===================\n"

CULIST=$(checkupdates)
if [[ $CULIST = "" ]]; then
    echo "No new packages"
    exit
fi

printf "${CULIST}"

# prompt
printf "\n\nLaunch yay -Syu? (y/N) "
read -r CONT
if [ "$CONT" = "y" ] || [ "$CONT" = "Y" ]; then
    printf "\n"
    yay -Syu
else
    printf "\nUpdate cancelled.\n"
    exit
fi

printf "\nLaunch paccache and remove uninstalled packages from cache? (y/N) "
read -r CONT
if [ "$CONT" = "y" ] || [ "$CONT" = "Y" ]; then
    printf "\n"
    paccache -ruk0
else
    printf "\nCache cleanup cancelled.\n"
fi
